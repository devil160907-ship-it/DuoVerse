<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DuoVerse - Join Requests</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4DA3FF">
    <meta name="room-id" content="{{ room_id }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DuoVerse">
    
    <style>
        .request-card {
            background: rgba(77, 163, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(77, 163, 255, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .request-card:hover {
            background: rgba(77, 163, 255, 0.12);
            border-color: rgba(77, 163, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(77, 163, 255, 0.15);
        }
        
        .request-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--glow-color), #6EB5FF);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 5px 20px rgba(77, 163, 255, 0.3);
        }
        
        .status-badge {
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-pending {
            background: rgba(255, 204, 0, 0.15);
            color: #FFD700;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .status-accepted {
            background: rgba(52, 199, 89, 0.15);
            color: #34C759;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }
        
        .status-rejected {
            background: rgba(255, 69, 58, 0.15);
            color: #FF453A;
            border: 1px solid rgba(255, 69, 58, 0.3);
        }
        
        .requests-header {
            background: linear-gradient(135deg, rgba(77, 163, 255, 0.15), rgba(110, 181, 255, 0.05));
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--glow-color);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--glow-color);
            border-color: var(--glow-color);
            color: white;
        }
        
        .filter-btn:hover {
            background: rgba(77, 163, 255, 0.2);
            border-color: var(--glow-color);
        }
        
        .empty-state {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 30px;
            padding: 60px 30px;
            text-align: center;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .action-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: none;
            font-size: 0.95rem;
        }
        
        .action-btn.accept {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
            border: 1px solid #34C759;
        }
        
        .action-btn.accept:hover {
            background: #34C759;
            color: white;
        }
        
        .action-btn.reject {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
            border: 1px solid #FF453A;
        }
        
        .action-btn.reject:hover {
            background: #FF453A;
            color: white;
        }
        
        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: rgba(77, 163, 255, 0.2);
            transform: translateX(-5px);
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            border-left: 5px solid var(--glow-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left-color: #34C759;
        }
        
        .toast.error {
            border-left-color: #FF453A;
        }
        
        .toast.info {
            border-left-color: var(--glow-color);
        }
        
        .redirect-banner {
            background: linear-gradient(135deg, #34C759, #30B04C);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.9; }
        }
        
        @media (max-width: 768px) {
            .requests-header {
                padding: 20px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .request-card {
                padding: 20px;
            }
            
            .toast {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="stars" style="position: fixed;"></div>
    
    <div class="container" style="max-width: 1200px; padding: 20px;">
        <!-- Back Button -->
        <a href="/meet/{{ room_id }}?host=true" class="back-button">
            <i class="fas fa-arrow-left" style="margin-right: 5px;"></i>
            <span>Back to Meeting Room</span>
        </a>
        
        <!-- Redirect Banner -->
        <div id="redirect-banner" class="redirect-banner" style="display: none;">
            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
            <div style="flex: 1;">
                <strong>Participant Accepted!</strong>
                <p style="margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9;">Redirecting you to the meeting room...</p>
            </div>
            <div class="spinner-small" style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        
        <!-- Main Content -->
        <div class="requests-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
                <div>
                    <h1 style="color: white; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-envelope" style="font-size: 2rem;"></i>
                        Join Requests
                    </h1>
                    <p style="color: rgba(255,255,255,0.7);">
                        Manage participant requests for <strong style="color: var(--glow-color);">{{ meeting_title }}</strong>
                    </p>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: flex; gap: 15px;">
                    <div class="stat-card">
                        <div class="stat-number" id="pending-count">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accepted-count">0</div>
                        <div class="stat-label">Accepted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-count">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="filter-btn active" data-filter="all"><i class="fas fa-list" style="margin-right: 5px;"></i> All Requests</button>
                <button class="filter-btn" data-filter="pending"><i class="fas fa-hourglass-half" style="margin-right: 5px;"></i> Pending</button>
                <button class="filter-btn" data-filter="accepted"><i class="fas fa-check-circle" style="margin-right: 5px;"></i> Accepted</button>
                <button class="filter-btn" data-filter="rejected"><i class="fas fa-times-circle" style="margin-right: 5px;"></i> Rejected</button>
            </div>
        </div>
        
        <!-- Requests Container -->
        <div id="requests-container" style="min-height: 400px;">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3 style="color: white; margin-bottom: 10px;">No Requests Yet</h3>
                <p style="color: rgba(255,255,255,0.6); margin-bottom: 20px;">When participants request to join, they will appear here</p>
                <a href="/meet/{{ room_id }}?host=true" class="action-btn secondary">
                    <i class="fas fa-arrow-left" style="margin-right: 5px;"></i> Return to Meeting Room
                </a>
            </div>
        </div>
        
        <!-- Auto Refresh Status -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-sync-alt fa-spin" style="color: var(--glow-color);"></i>
                <span style="color: rgba(255,255,255,0.6);">Auto-refreshing</span>
                <span id="refresh-timer" style="color: var(--glow-color); font-weight: 600;">3s</span>
            </div>
            <button id="refresh-now-btn" class="control-btn" style="padding: 8px 16px;">
                <i class="fas fa-redo-alt"></i> Refresh Now
            </button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <div style="flex: 1;">
            <div id="toast-title" style="font-weight: 600; margin-bottom: 5px;">Title</div>
            <div id="toast-message" style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">Message</div>
        </div>
    </div>
    
    <script>
        const roomId = '{{ room_id }}';
        const meetingId = {{ meeting.id }};
        
        let currentFilter = 'all';
        let allRequests = [];
        let refreshInterval;
        let secondsUntilRefresh = 3;
        let isRedirecting = false;
        
        const toast = {
            element: document.getElementById('toast'),
            icon: document.getElementById('toast-icon'),
            title: document.getElementById('toast-title'),
            message: document.getElementById('toast-message'),
            timeout: null,
            
            show: function(title, message, type = 'info', duration = 4000) {
                if (this.timeout) {
                    clearTimeout(this.timeout);
                }
                
                this.title.textContent = title;
                this.message.textContent = message;
                
                if (type === 'success') {
                    this.icon.className = 'fas fa-check-circle';
                    this.element.className = 'toast success show';
                } else if (type === 'error') {
                    this.icon.className = 'fas fa-exclamation-circle';
                    this.element.className = 'toast error show';
                } else {
                    this.icon.className = 'fas fa-info-circle';
                    this.element.className = 'toast info show';
                }
                
                this.timeout = setTimeout(() => {
                    this.element.classList.remove('show');
                }, duration);
            },
            
            hide: function() {
                this.element.classList.remove('show');
            }
        };
        
        function confirmDialog(title, message, onConfirm) {
            if (typeof window.confirm === 'function') {
                if (confirm(`${title}\n${message}`)) {
                    onConfirm();
                }
            } else {
                onConfirm();
            }
        }
        
        async function fetchAllRequests() {
            try {
                const response = await fetch(`/api/join-requests/all/${roomId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                allRequests = data.requests || [];
                
                updateStats();
                renderRequests();
                
                return allRequests;
            } catch (error) {
                console.error('Failed to fetch requests:', error);
                toast.show('Error', 'Failed to load join requests', 'error');
                return [];
            }
        }
        
        async function handleRequestAction(requestId, action) {
            try {
                const response = await fetch(`/api/join-request/${requestId}/${action}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    const requestIndex = allRequests.findIndex(r => r.id === requestId);
                    if (requestIndex !== -1) {
                        allRequests[requestIndex].status = action === 'accept' ? 'accepted' : 'rejected';
                        allRequests[requestIndex].responded_at = new Date().toISOString();
                    }
                    
                    renderRequests();
                    updateStats();
                    
                    const actionText = action === 'accept' ? 'accepted' : 'rejected';
                    toast.show(
                        'Request ' + (action === 'accept' ? 'Accepted' : 'Rejected'),
                        `Participant request has been ${actionText}`,
                        'success'
                    );
                    
                    if (action === 'accept' && !isRedirecting) {
                        isRedirecting = true;
                        
                        const banner = document.getElementById('redirect-banner');
                        if (banner) {
                            banner.style.display = 'flex';
                        }
                        
                        toast.show(
                            'ðŸŽ‰ Participant Added!',
                            'Redirecting you to the meeting room...',
                            'success',
                            2000
                        );
                        
                        setTimeout(() => {
                            window.location.href = `/meet/${roomId}?host=true&participant=connected&accepted=true&start=true`;
                        }, 1500);
                    }
                    
                    return true;
                } else {
                    throw new Error('Failed to process request');
                }
            } catch (error) {
                console.error(`Failed to ${action} request:`, error);
                toast.show('Error', `Failed to ${action} request`, 'error');
                return false;
            }
        }
        
        async function clearAllRejected() {
            try {
                const response = await fetch(`/api/join-requests/clear-rejected/${roomId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    allRequests = allRequests.filter(r => r.status !== 'rejected');
                    
                    renderRequests();
                    updateStats();
                    
                    toast.show('Cleared', 'All rejected requests have been removed', 'success');
                    return true;
                }
            } catch (error) {
                console.error('Failed to clear rejected requests:', error);
                toast.show('Error', 'Failed to clear rejected requests', 'error');
                return false;
            }
        }
        
        function updateStats() {
            const pendingCount = allRequests.filter(r => r.status === 'pending').length;
            const acceptedCount = allRequests.filter(r => r.status === 'accepted').length;
            const totalCount = allRequests.length;
            
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('accepted-count').textContent = acceptedCount;
            document.getElementById('total-count').textContent = totalCount;
        }
        
        function renderRequests() {
            const container = document.getElementById('requests-container');
            
            let filteredRequests = allRequests;
            if (currentFilter !== 'all') {
                filteredRequests = allRequests.filter(r => r.status === currentFilter);
            }
            
            filteredRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredRequests.length === 0) {
                let emptyMessage = 'No requests found';
                let emptyIcon = 'fa-inbox';
                
                if (currentFilter === 'pending') {
                    emptyMessage = 'No pending requests';
                    emptyIcon = 'fa-hourglass';
                } else if (currentFilter === 'accepted') {
                    emptyMessage = 'No accepted requests yet';
                    emptyIcon = 'fa-check-circle';
                } else if (currentFilter === 'rejected') {
                    emptyMessage = 'No rejected requests';
                    emptyIcon = 'fa-times-circle';
                }
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas ${emptyIcon}"></i>
                        </div>
                        <h3 style="color: white; margin-bottom: 10px;">${emptyMessage}</h3>
                        <p style="color: rgba(255,255,255,0.6); margin-bottom: 20px;">
                            ${currentFilter === 'all' ? 'When participants request to join, they will appear here' : 'Try changing the filter'}
                        </p>
                        ${currentFilter !== 'all' ? `
                            <button onclick="setFilter('all')" class="action-btn secondary">
                                <i class="fas fa-list"></i> View All Requests
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredRequests.forEach(request => {
                const timestamp = new Date(request.timestamp);
                const formattedDate = timestamp.toLocaleDateString();
                const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const avatarColor = stringToColor(request.requester);
                const avatarInitial = request.requester.charAt(0).toUpperCase();
                
                let statusBadge = '';
                let statusClass = '';
                
                if (request.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending"><i class="fas fa-hourglass-half"></i> Pending</span>';
                } else if (request.status === 'accepted') {
                    statusBadge = '<span class="status-badge status-accepted"><i class="fas fa-check-circle"></i> Accepted</span>';
                } else if (request.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Rejected</span>';
                }
                
                let actionButtons = '';
                if (request.status === 'pending') {
                    actionButtons = `
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button onclick="handleRequestAction(${request.id}, 'accept')" class="action-btn accept">
                                <i class="fas fa-check"></i> Accept & Join Meeting
                            </button>
                            <button onclick="handleRequestAction(${request.id}, 'reject')" class="action-btn reject">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    `;
                }
                
                html += `
                    <div class="request-card" data-request-id="${request.id}" data-status="${request.status}">
                        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                            <div class="request-avatar" style="background: linear-gradient(135deg, ${avatarColor}, ${adjustColor(avatarColor, 30)});">
                                ${avatarInitial}
                            </div>
                            
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                                    <div>
                                        <h3 style="color: white; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                                            Participant
                                            ${statusBadge}
                                        </h3>
                                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                                            <i class="fas fa-id-card" style="margin-right: 5px;"></i> ${request.requester_short || request.requester.substring(0, 8) + '...'}
                                        </p>
                                    </div>
                                    <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">
                                        <i class="far fa-calendar-alt"></i> ${formattedDate} <i class="far fa-clock" style="margin-left: 5px;"></i> ${formattedTime}
                                    </p>
                                </div>
                                
                                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                                        <i class="fas fa-hashtag"></i> Request ID: ${request.id}
                                    </span>
                                    ${request.responded_at ? `
                                        <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                                            <i class="fas fa-clock"></i> Responded: ${new Date(request.responded_at).toLocaleTimeString()}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (currentFilter === 'rejected' && filteredRequests.length > 0) {
                html = `
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                        <button onclick="clearAllRejected()" class="action-btn secondary">
                            <i class="fas fa-trash-alt"></i> Clear All Rejected
                        </button>
                    </div>
                ` + html;
            }
            
            container.innerHTML = html;
        }
        
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }
        
        function adjustColor(color, amount) {
            if (color.startsWith('hsl')) {
                return color;
            }
            return color;
        }
        
        function setFilter(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.filter-btn[data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            renderRequests();
        }
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                secondsUntilRefresh--;
                
                const timerElement = document.getElementById('refresh-timer');
                if (timerElement) {
                    timerElement.textContent = `${secondsUntilRefresh}s`;
                }
                
                if (secondsUntilRefresh <= 0) {
                    fetchAllRequests();
                    secondsUntilRefresh = 3;
                }
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            fetchAllRequests();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    setFilter(filter);
                });
            });
            
            const refreshBtn = document.getElementById('refresh-now-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    fetchAllRequests();
                    secondsUntilRefresh = 3;
                });
            }
            
            startAutoRefresh();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('redirect') === 'true') {
                const banner = document.getElementById('redirect-banner');
                if (banner) {
                    banner.style.display = 'flex';
                }
            }
        });
        
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='js/alert.js') }}"></script>
</body>
</html>